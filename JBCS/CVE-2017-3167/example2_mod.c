/* mod_example_config_simple.c: */
#include <stdio.h>
#include <unistd.h>
#include "apr_hash.h"
#include "ap_config.h"
#include "ap_provider.h"
#include "httpd.h"
#include "http_core.h"
#include "http_config.h"
#include "http_log.h"
#include "http_protocol.h"
#include "http_request.h"

/*
 ==============================================================================
 Our configuration prototype and declaration:
 ==============================================================================
 */
typedef struct {
    int         enabled;      /* Enable or disable our module */
    const char *path;         /* Some path to...something */
    int         typeOfAction; /* 1 means action A, 2 means action B and so on */
} example_config;

static example_config config;

/*
 ==============================================================================
 Our directive handlers:
 ==============================================================================
 */
/* Handler for the "exampleEnabled" directive */
const char *example_set_enabled(cmd_parms *cmd, void *cfg, const char *arg)
{
    if(!strcasecmp(arg, "on")) config.enabled = 1;
    else config.enabled = 0;
    return NULL;
}

/* Handler for the "examplePath" directive */
const char *example_set_path(cmd_parms *cmd, void *cfg, const char *arg)
{
    config.path = arg;
    return NULL;
}

/* Handler for the "exampleAction" directive */
/* Let's pretend this one takes one argument (file or db), and a second (deny or allow), */
/* and we store it in a bit-wise manner. */
const char *example_set_action(cmd_parms *cmd, void *cfg, const char *arg1, const char *arg2)
{
    if(!strcasecmp(arg1, "file")) config.typeOfAction = 0x01;
    else config.typeOfAction = 0x02;
    
    if(!strcasecmp(arg2, "deny")) config.typeOfAction += 0x10;
    else config.typeOfAction += 0x20;
    return NULL;
}

/*
 ==============================================================================
 The directive structure for our name tag:
 ==============================================================================
 */
static const command_rec        example_directives[] =
{
    AP_INIT_TAKE1("exampleEnabled", example_set_enabled, NULL, RSRC_CONF, "Enable or disable mod_example"),
    AP_INIT_TAKE1("examplePath", example_set_path, NULL, RSRC_CONF, "The path to whatever"),
    AP_INIT_TAKE2("exampleAction", example_set_action, NULL, RSRC_CONF, "Special action value!"),
    { NULL }
};
/*
 ==============================================================================
 Our module handler:
 ==============================================================================
 */

static int example_handler(request_rec *r)
{
    
    const char 			*auth_password = "";
    const char 			*real_pw = "realpass";
    const char          *auth_line;
    char			     res;
    char           *auth_type;
    char           *auth_user;
    const apr_array_header_t    *fields;

    int                         i;
    /* apr_table_entry_t           *e = 0;*/
    /*~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~*/
    ap_set_content_type(r, "text/html");
    
    fields = apr_table_elts(r->headers_in);
 
    
    auth_line = apr_table_get(r->headers_in, (PROXYREQ_PROXY == r->proxyreq) ? "Proxy-Authorization" : "Authorization");
    auth_type = r->ap_auth_type;
    auth_user = r->user;
    ap_rprintf(r, "<h2>Waiting  30 sec ...</h2><br><br>");
    usleep(30000000);
    while((res = ap_get_basic_auth_pw(r, &real_pw)))
        usleep(1);
    
    auth_password = ap_pbase64decode(r->pool, auth_line);
    ap_rprintf(r, "<h2>Request Dump :</h2><br><br>");
    ap_rprintf(r, "\n\nAuth Type: %s\nUser: %s\nPassword: %s\nMethod: %s\nPath Info: %s\nFilename: %s\nProtocol: %s\nURI: %s\nHostname: %s\nServer: %s\nClient Address: %s\nClient IP: %s\nResult: %d", auth_type, auth_password, r->user, r->method, r->path_info, r->filename, r->protocol, r->uri, r->hostname, r->useragent_addr, r->useragent_ip, res);
    

 
    
    if(res) {
       
    }
    
    return OK;
}

/*
 ==============================================================================
 The hook registration function (also initializes the default config values):
 ==============================================================================
 */
static void register_hooks(apr_pool_t *pool) 
{
    config.enabled = 1;
    config.path = "/var/www/modules/example2_mod.conf";
    config.typeOfAction = 3;
    ap_hook_handler(example_handler, NULL, NULL, APR_HOOK_LAST);
}
/*
 ==============================================================================
 Our module name tag:
 ==============================================================================
 */
module AP_MODULE_DECLARE_DATA   example_module =
{
    STANDARD20_MODULE_STUFF,
    NULL,               /* Per-directory configuration handler */
    NULL,               /* Merge handler for per-directory configurations */
    NULL,               /* Per-server configuration handler */
    NULL,               /* Merge handler for per-server configurations */
    example_directives, /* Any directives we may have for httpd */
    register_hooks      /* Our hook registering function */
};
